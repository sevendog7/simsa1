<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>적극행정 우수사례 2차 심사표 집계</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            opacity: 0;
            transition: visibility 0s 0.5s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s linear;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl p-8 relative">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">적극행정 우수사례 2차 심사표 (개인별)</h1>
        
        <div class="absolute top-8 right-8 flex space-x-4 no-print">
            <button id="send-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                전송
            </button>
            <button id="print-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                출력 (MS Word)
            </button>
        </div>

        <div class="overflow-x-auto rounded-xl mb-8">
            <table class="w-full text-sm text-left text-gray-700 rounded-xl overflow-hidden">
                <thead class="text-xs text-white uppercase bg-blue-600">
                    <tr>
                        <th scope="col" class="px-3 py-2 text-center">연번</th>
                        <th scope="col" class="px-3 py-2 text-center">사례명</th>
                        <th scope="col" class="px-3 py-2 text-center">국민<br>체감도 (20)</th>
                        <th scope="col" class="px-3 py-2 text-center">적극성<br>및 창의성 (30)</th>
                        <th scope="col" class="px-3 py-2 text-center">중요도 및<br>난이도 (30)</th>
                        <th scope="col" class="px-3 py-2 text-center">확산<br>가능성 (10)</th>
                        <th scope="col" class="px-3 py-2 text-center">국민<br>호응도 (10)</th>
                        <th scope="col" class="px-3 py-2 text-center font-bold">합계 (100)</th>
                    </tr>
                </thead>
                <tbody id="score-table-body" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>

        <div class="flex flex-col sm:flex-row justify-end items-center space-y-4 sm:space-y-0 sm:space-x-8 mt-8">
            <div class="flex items-center space-x-2">
                <label for="judge-name" class="text-gray-700 font-semibold">작성자(심사위원):</label>
                <div class="flex items-center p-2 border-b border-gray-300">
                    <input type="text" id="judge-name" class="p-1 w-32 focus:outline-none bg-white">
                    <span class="ml-2 font-bold">(인)</span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <label for="chair-name" class="text-gray-700 font-semibold">확인자(위원장):</label>
                <div class="flex items-center p-2 border-b border-gray-300">
                    <input type="text" id="chair-name" class="p-1 w-32 focus:outline-none bg-white">
                    <span class="ml-2 font-bold">(인)</span>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-notification" class="toast"></div>

    <script type="module">
        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let db;

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showToast("데이터베이스 연결에 실패했습니다.", true);
            }
            
            initializePage();
        });

        function initializePage() {
            const tableBody = document.getElementById('score-table-body');
            const numRows = 10;

            for (let i = 1; i <= numRows; i++) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-3 py-2 text-center text-gray-900 font-medium">${i}</td>
                    <td class="px-3 py-2"><input type="text" id="case-${i}-name" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 transition duration-300 text-sm"></td>
                    <td class="px-3 py-2 text-center"><input type="number" data-score-for="case-${i}" data-max="20" class="score-input w-20 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 text-center transition duration-300 text-sm"></td>
                    <td class="px-3 py-2 text-center"><input type="number" data-score-for="case-${i}" data-max="30" class="score-input w-20 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 text-center transition duration-300 text-sm"></td>
                    <td class="px-3 py-2 text-center"><input type="number" data-score-for="case-${i}" data-max="30" class="score-input w-20 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 text-center transition duration-300 text-sm"></td>
                    <td class="px-3 py-2 text-center"><input type="number" data-score-for="case-${i}" data-max="10" class="score-input w-20 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 text-center transition duration-300 text-sm"></td>
                    <td class="px-3 py-2 text-center"><input type="number" data-score-for="case-${i}" data-max="10" class="score-input w-20 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 text-center transition duration-300 text-sm"></td>
                    <td class="px-3 py-2 text-center font-bold text-lg text-blue-700" id="total-case-${i}">0</td>
                `;
                tableBody.appendChild(row);
            }

            const scoreInputs = document.querySelectorAll('.score-input');
            scoreInputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    const caseId = event.target.dataset.scoreFor;
                    calculateTotal(caseId);
                });
            });

            document.getElementById('send-button').addEventListener('click', sendDataToFirestore);
            document.getElementById('print-button').addEventListener('click', generateWordDoc);
        }

        function calculateTotal(caseId) {
            const scoreInputs = document.querySelectorAll(`[data-score-for="${caseId}"]`);
            let total = 0;
            scoreInputs.forEach(input => {
                input.value = input.value.split('.')[0];
                const value = parseInt(input.value) || 0;
                const max = parseInt(input.dataset.max);
                if (value > max) { input.value = max; }
                else if (value < 0) { input.value = 0; }
                total += parseInt(input.value) || 0;
            });
            document.getElementById(`total-${caseId}`).innerText = total;
        }

        async function sendDataToFirestore() {
            if (!db) {
                showToast("데이터베이스에 연결되지 않았습니다.", true);
                return;
            }
            const judgeName = document.getElementById('judge-name').value.trim();
            if (!judgeName) {
                showToast("작성자(심사위원) 이름을 입력해주세요.", true);
                return;
            }

            const rows = document.querySelectorAll('#score-table-body tr');
            const results = [];
            let hasData = false;

            rows.forEach(row => {
                const caseNumber = row.querySelector('td:first-child').innerText;
                const caseName = row.querySelector(`#case-${caseNumber}-name`).value.trim();
                const totalScore = parseInt(row.querySelector(`#total-case-${caseNumber}`).innerText) || 0;
                
                if (totalScore > 0 || caseName !== '') {
                    hasData = true;
                }
                results.push({ 
                    number: parseInt(caseNumber), 
                    name: caseName, 
                    score: totalScore 
                });
            });

            if (!hasData) {
                showToast("전송할 데이터가 없습니다. 점수나 사례명을 입력해주세요.", true);
                return;
            }

            const payload = {
                judgeName: judgeName,
                results: results,
                submittedAt: serverTimestamp()
            };

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/scores`, judgeName);
                await setDoc(docRef, payload);
                showToast("심사 결과가 성공적으로 전송되었습니다.");
            } catch (error) {
                console.error("Error writing document: ", error);
                showToast("전송 중 오류가 발생했습니다.", true);
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function generateWordDoc() {
             // This function remains unchanged for Word export
            const judgeName = document.getElementById('judge-name').value;
            const chairName = document.getElementById('chair-name').value;
            let tableHtml = '';
            document.querySelectorAll('#score-table-body tr').forEach(row => {
                const caseName = row.querySelector(`#case-${row.querySelector('td').innerText}-name`).value;
                const scores = Array.from(row.querySelectorAll('.score-input')).map(input => input.value);
                const totalScore = row.querySelector('.text-lg').innerText;
                tableHtml += `<tr><td>${row.querySelector('td').innerText}</td><td>${caseName}</td><td>${scores[0]}</td><td>${scores[1]}</td><td>${scores[2]}</td><td>${scores[3]}</td><td>${scores[4]}</td><td>${totalScore}</td></tr>`;
            });
            const htmlContent = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>적극행정 우수사례 2차 심사표 집계</title><style>body{font-family:'Malgun Gothic','맑은 고딕',sans-serif;font-size:8pt;margin:0;padding:20px;box-sizing:border-box;}.header{text-align:center;}table{width:100%;border-collapse:collapse;margin-bottom:10px;page-break-inside:avoid;}th,td{border:1px solid #000;padding:3px;text-align:center;vertical-align:middle;}th{background-color:#f2f2f2;}.main-table th{background-color:#d1e2f7;}.signature-box{display:flex;justify-content:flex-end;margin-top:20px;font-size:10pt;}.signature-item{margin-left:30px;}.reference-table th{background-color:#e0e0e0;}.reference-table td,.reference-table th{font-size:6pt;vertical-align:middle;}.reference-table ul{text-align:left;margin:0;padding:0 0 0 10px;list-style-type:disc;}</style></head><body><div class="header"><h1 style="font-size:14pt;font-weight:bold;margin-bottom:10px;">적극행정 우수사례 2차 심사표 (개인별)</h1></div><table class="main-table"><thead><tr><th style="width:5%;">연번</th><th style="width:30%;">사례명</th><th style="width:10%;">국민 체감도 (20)</th><th style="width:10%;">적극성<br>및 창의성 (30)</th><th style="width:10%;">중요도 및<br>난이도 (30)</th><th style="width:10%;">확산 가능성 (10)</th><th style="width:10%;">국민 호응도 (10)</th><th style="width:15%;">합계 (100)</th></tr></thead><tbody>${tableHtml}</tbody></table><div class="signature-box"><div class="signature-item"><label>작성자(심사위원): ${judgeName} (인)</label></div><div class="signature-item"><label>확인자(위원장): ${chairName} (인)</label></div></div></body></html>`;
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '적극행정_심사표.doc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
